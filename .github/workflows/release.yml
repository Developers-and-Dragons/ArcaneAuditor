name: üîè Sign & Release

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:

  windows-sign:
    name: üîè Windows EV Signing
    runs-on: self-hosted  # Your EV token machine

    steps:
      - name: üì• Download unsigned artifacts from vdevelop release
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          New-Item -ItemType Directory -Force -Path ./unsigned | Out-Null
          gh release download vdevelop --repo ${{ github.repository }} --dir ./unsigned --pattern "*.exe" --clobber
          Write-Host "üì¶ Downloaded files:"
          Get-ChildItem ./unsigned | Format-Table Name, Length, LastWriteTime

      - name: üîè Sign executables (local EV cert)
        shell: pwsh
        run: |
          $thumb = "A5EBA89B65F776DB3DEB350BD3681BFF52AFE2E8"
          Get-ChildItem ./unsigned -Filter *.exe | ForEach-Object {
            Write-Host "üîè Signing: $($_.Name)"
            & signtool sign `
              /sha1 $thumb `
              /fd sha256 `
              /td sha256 `
              /tr http://timestamp.digicert.com `
              $_.FullName
            
            if ($LASTEXITCODE -ne 0) {
              Write-Error "Failed to sign $($_.Name)"
              exit 1
            }
          }

      - name: üì§ Upload signed Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: signed-windows
          path: ./unsigned/*.exe

  mac-sign-notarize:
    name: üçé macOS Sign + Notarize
    runs-on: macos-latest

    steps:
      - name: üì• Download unsigned macOS artifacts from vdevelop release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p ./dist
          
          # Download CLI
          gh release download vdevelop --repo ${{ github.repository }} --dir ./dist --pattern "ArcaneAuditorCLI" --clobber
          
          # Download and extract .app bundle
          gh release download vdevelop --repo ${{ github.repository }} --dir ./dist --pattern "ArcaneAuditor.app.zip" --clobber
          
          if [ -f ./dist/ArcaneAuditor.app.zip ]; then
            echo "üì¶ Extracting ArcaneAuditor.app..."
            cd ./dist
            unzip -q -o ArcaneAuditor.app.zip
            rm ArcaneAuditor.app.zip
            cd ..
          fi
          
          echo "üì¶ Downloaded and extracted files:"
          ls -lh ./dist/
          echo "üì¶ App bundle structure:"
          ls -lh ./dist/ArcaneAuditor.app/Contents/ || true

      - name: üîè Import mac certificate
        env:
          MAC_CERT: ${{ secrets.MACOS_CERTIFICATE }}
          MAC_CERT_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
        run: |
          echo "$MAC_CERT" | base64 --decode > cert.p12
          security create-keychain -p password build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p password build.keychain
          security import cert.p12 -k build.keychain -P "$MAC_CERT_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k password build.keychain
          rm cert.p12

      - name: üîè Codesign App & CLI
        env:
          MAC_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY }}
        run: |
          # Sign the CLI binary
          echo "üîè Signing CLI binary..."
          codesign --force --options runtime --sign "$MAC_IDENTITY" dist/ArcaneAuditorCLI --timestamp
          
          # For PyInstaller bundles, we need to sign all Mach-O binaries inside the app
          echo "üîè Finding and signing Mach-O binaries in app bundle..."
          
          # Sign all actual Mach-O files (executables, dylibs, frameworks)
          # Use 'file' command to identify real binaries, not just by extension
          find dist/ArcaneAuditor.app/Contents -type f | while read f; do
            if file "$f" | grep -q "Mach-O"; then
              echo "  Signing: $f"
              codesign --force --options runtime --sign "$MAC_IDENTITY" "$f" --timestamp 2>/dev/null || true
            fi
          done
          
          # Finally, sign the entire app bundle
          echo "üîè Signing main app bundle..."
          codesign --force --options runtime --sign "$MAC_IDENTITY" dist/ArcaneAuditor.app --timestamp
          
          # Verify signatures
          echo "‚úÖ Verifying CLI signature..."
          codesign --verify --verbose dist/ArcaneAuditorCLI
          echo "‚úÖ Verifying App signature..."
          codesign --verify --verbose dist/ArcaneAuditor.app
          echo "‚úÖ Checking app signature details..."
          codesign -dvv dist/ArcaneAuditor.app

      - name: üöÄ Notarize App
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        run: |
          ditto -c -k --keepParent dist/ArcaneAuditor.app dist/ArcaneAuditor.zip
          xcrun notarytool submit dist/ArcaneAuditor.zip \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_APP_SPECIFIC_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait
          xcrun stapler staple dist/ArcaneAuditor.app
          
          # Verify notarization
          spctl -a -vv dist/ArcaneAuditor.app

      - name: üì¶ Create DMG
        run: |
          mkdir dmg
          cp -R dist/ArcaneAuditor.app dmg/
          hdiutil create -volname "Arcane Auditor" \
            -srcfolder dmg \
            -ov -format UDZO \
            dist/ArcaneAuditor_macOS_Desktop.dmg
          rm -rf dmg
          
          # Sign the DMG as well
          codesign --force --sign "${{ secrets.MACOS_SIGNING_IDENTITY }}" dist/ArcaneAuditor_macOS_Desktop.dmg

      - name: üì§ Upload mac artifacts
        uses: actions/upload-artifact@v4
        with:
          name: signed-macos
          path: |
            dist/*.dmg
            dist/ArcaneAuditorCLI

  publish:
    name: üöÄ Publish GitHub Release
    runs-on: ubuntu-latest
    needs: [windows-sign, mac-sign-notarize]

    steps:
      - uses: actions/checkout@v4

      - name: üì• Download all signed artifacts
        uses: actions/download-artifact@v4
        with:
          path: signed-artifacts

      - name: üìã List all signed artifacts
        run: |
          echo "üì¶ All signed artifacts:"
          ls -R ./signed-artifacts/

      - name: üéØ Organize for release
        run: |
          mkdir -p release-files
          find ./signed-artifacts -type f \( -name "*.exe" -o -name "*.dmg" -o -name "ArcaneAuditorCLI" \) -exec cp {} ./release-files/ \;
          echo "üì¶ Files ready for release:"
          ls -lh ./release-files/

      - name: üöÄ Create Draft Release & Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          files: release-files/*
          draft: true
          prerelease: false
          body: "Signed release artifacts. Please add release notes before publishing."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}